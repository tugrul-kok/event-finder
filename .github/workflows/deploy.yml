name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manuel tetikleme iÃ§in

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Proje dizinine git
            cd /var/www/event-finder
            
            # Git repo kontrolÃ¼ ve kodlarÄ± Ã§ekme
            if [ -d .git ]; then
              echo "ðŸ”§ Configuring git safe directory..."
              git config --global --add safe.directory /var/www/event-finder || true
              
              echo "ðŸ“¥ Fetching latest changes..."
              git fetch origin main
              echo "ðŸ”„ Hard reset to origin/main..."
              git reset --hard origin/main
              git clean -fd
            else
              echo "âŒ Git repository bulunamadÄ±! LÃ¼tfen sunucuda manuel clone yapÄ±n."
              exit 1
            fi
            
            # Docker iÃ§in gerekli klasÃ¶rlerin varlÄ±ÄŸÄ±ndan emin ol
            echo "ðŸ“ Checking directories..."
            mkdir -p model_cache
            
            # Docker Image Build
            echo "ðŸ³ Building Docker image..."
            docker build -t event-finder-img .
            
            # Eski konteyneri durdur ve sil
            echo "ðŸ›‘ Stopping old container..."
            docker stop event-finder || true
            docker rm event-finder || true
            
            # Yeni konteyneri baÅŸlat (RAM tasarrufu modu)
            echo "ðŸš€ Starting new container (RAM optimized mode)..."
            docker run -d \
              --name event-finder \
              --restart always \
              --network event-net \
              -p 127.0.0.1:5001:5001 \
              -e MONGO_URI="mongodb://mongodb:27017/" \
              -v /var/www/event-finder/.env:/app/.env \
              -v /var/www/event-finder/model_cache:/app/model_cache \
              event-finder-img \
              gunicorn --workers 1 --threads 4 --bind 0.0.0.0:5001 events_backend:app
            
            # Gereksiz eski imajlarÄ± temizle (Disk tasarrufu)
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            # Servis durumunu kontrol et
            echo "âœ… Checking container status..."
            sleep 5
            if [ "$(docker inspect -f '{{.State.Running}}' event-finder)" = "true" ]; then
                echo "Container is running!"
            else
                echo "âŒ Container failed to start!"
                docker logs event-finder
                exit 1
            fi
            
            # Health check (Local)
            echo "ðŸ¥ Internal Health check..."
            curl -f http://localhost:5001/health || echo "âš ï¸ Internal health check failed (service might still be initializing)"
            
            # SSL kontrolÃ¼ ve Nginx yapÄ±landÄ±rmasÄ±
            echo "ðŸ” SSL sertifikasÄ± kontrol ediliyor..."
            if [ -f /etc/letsencrypt/live/events.tugrul.app/fullchain.pem ]; then
                echo "âœ… SSL sertifikasÄ± mevcut - Nginx HTTPS yapÄ±landÄ±rmasÄ± gÃ¼ncelleniyor..."
                # Mevcut SSL sertifikasÄ±nÄ± kullanarak nginx'i yapÄ±landÄ±r
                if [ -f /var/www/event-finder/setup-ssl.sh ]; then
                    chmod +x /var/www/event-finder/setup-ssl.sh
                    if bash /var/www/event-finder/setup-ssl.sh; then
                        echo "âœ… SSL yapÄ±landÄ±rmasÄ± baÅŸarÄ±lÄ±"
                    else
                        echo "âš ï¸  setup-ssl.sh Ã§alÄ±ÅŸtÄ±rÄ±lamadÄ±, nginx config'i manuel kontrol ediliyor..."
                        # Nginx config test et
                        if nginx -t; then
                            echo "âœ… Nginx config geÃ§erli, nginx baÅŸlatÄ±lÄ±yor..."
                            systemctl start nginx || systemctl restart nginx
                        else
                            echo "âŒ Nginx config hatasÄ±! Detaylar:"
                            nginx -t 2>&1
                            echo "âš ï¸  Nginx baÅŸlatÄ±lamadÄ±, lÃ¼tfen manuel kontrol edin"
                        fi
                    fi
                else
                    echo "âš ï¸  setup-ssl.sh bulunamadÄ±, nginx'i yeniden baÅŸlatÄ±yoruz..."
                    if nginx -t; then
                        systemctl start nginx || systemctl restart nginx
                    else
                        echo "âŒ Nginx config hatasÄ±!"
                        nginx -t 2>&1
                    fi
                fi
            else
                echo "âš ï¸  SSL sertifikasÄ± bulunamadÄ± - HTTP modunda Ã§alÄ±ÅŸÄ±yor"
                echo "ðŸ’¡ HTTPS iÃ§in sunucuda ÅŸu komutu Ã§alÄ±ÅŸtÄ±rÄ±n: sudo bash /var/www/event-finder/setup-ssl.sh"
                if nginx -t; then
                    systemctl start nginx || systemctl restart nginx
                else
                    echo "âŒ Nginx config hatasÄ±!"
                    nginx -t 2>&1
                fi
            fi
            
            # Nginx durumunu kontrol et
            sleep 2
            if systemctl is-active --quiet nginx; then
                echo "âœ… Nginx Ã§alÄ±ÅŸÄ±yor"
            else
                echo "âŒ Nginx Ã§alÄ±ÅŸmÄ±yor! Durum:"
                systemctl status nginx --no-pager || true
            fi
            
            echo "âœ… Deployment completed successfully!"
          EOF
      
      - name: Verify deployment (Public)
        run: |
          echo "Waiting for service to stabilize..."
          sleep 10
          # Try HTTPS first, fallback to HTTP if SSL not configured
          curl -f https://events.tugrul.app/health 2>/dev/null || curl -f http://events.tugrul.app/health || echo "âš ï¸ Public health check failed"
      
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code deployed to server" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ³ Docker image rebuilt and container restarted" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Web: https://events.tugrul.app" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š API: https://events.tugrul.app/api" >> $GITHUB_STEP_SUMMARY