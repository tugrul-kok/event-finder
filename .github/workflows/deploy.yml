name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manuel tetikleme iÃ§in

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Proje dizinine git
            cd /var/www/event-finder
            
            # Git repo kontrolÃ¼ ve hard reset
            if [ -d .git ]; then
              # Git ownership sorununu Ã§Ã¶z
              echo "ðŸ”§ Configuring git safe directory..."
              git config --global --add safe.directory /var/www/event-finder || true
              
              echo "ðŸ“¥ Fetching latest changes..."
              git fetch origin main
              echo "ðŸ”„ Hard reset to origin/main..."
              git reset --hard origin/main
              git clean -fd
            else
              echo "âŒ Git repository bulunamadÄ±!"
              echo "Ä°lk kurulum iÃ§in: git clone https://github.com/tugrul-kok/event-finder.git /var/www/event-finder"
              exit 1
            fi
            
            # Virtual environment kontrolÃ¼ ve aktif etme
            if [ -d venv ]; then
              echo "ðŸ Virtual environment bulundu, aktif ediliyor..."
              source venv/bin/activate
              
              # Requirements gÃ¼ncelle (eÄŸer deÄŸiÅŸtiyse)
              echo "ðŸ“¦ Updating Python packages..."
              pip install -q --upgrade pip
              pip install -q -r requirements.txt
            else
              echo "âš ï¸  Virtual environment bulunamadÄ±, sistem Python kullanÄ±lÄ±yor..."
              echo "ðŸ“¦ Updating Python packages (system-wide)..."
              pip3 install -q --upgrade pip
              pip3 install -q -r requirements.txt
            fi
            
            # events_backend.py'yi app.py olarak kopyala (eÄŸer yoksa)
            if [ ! -f app.py ] && [ -f events_backend.py ]; then
              echo "ðŸ“ Creating app.py from events_backend.py..."
              cp events_backend.py app.py
            fi
            
            # Dosya izinlerini dÃ¼zelt
            echo "ðŸ”§ Setting permissions..."
            sudo chown -R www-data:www-data /var/www/event-finder
            sudo chmod -R 755 /var/www/event-finder
            
            # RAG embeddings'i yeniden oluÅŸtur (opsiyonel, ilk sorguda otomatik oluÅŸacak)
            echo "ðŸ§  RAG embeddings will be regenerated on next query or service restart"
            
            # Servisi yeniden baÅŸlat
            echo "ðŸ”„ Restarting service..."
            sudo systemctl restart events
            
            # Servis durumunu kontrol et
            echo "âœ… Checking service status..."
            sleep 3
            sudo systemctl status events --no-pager || true
            
            # Health check
            echo "ðŸ¥ Health check..."
            curl -f http://localhost:5001/health || echo "âš ï¸ Health check failed (service might still be starting)"
            
            echo "âœ… Deployment completed!"
          EOF
      
      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://events.tugrul.app/health || echo "âš ï¸ Health check failed"
      
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code deployed to server" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Service restarted" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Web: https://events.tugrul.app" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š API: https://events.tugrul.app/api" >> $GITHUB_STEP_SUMMARY

