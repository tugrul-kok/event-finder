name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manuel tetikleme iÃ§in

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Proje dizinine git
            cd /var/www/event-finder
            
            # Git pull (eÄŸer repo clone edilmiÅŸse)
            if [ -d .git ]; then
              echo "ðŸ“¥ Pulling latest changes..."
              git pull origin main
            else
              echo "ðŸ“‹ Copying files..."
              # EÄŸer git yoksa, dosyalarÄ± manuel kopyala
              # Bu durumda GitHub Actions'tan dosyalarÄ± SCP ile kopyalayabiliriz
            fi
            
            # Virtual environment'Ä± aktif et
            source venv/bin/activate
            
            # Requirements gÃ¼ncelle (eÄŸer deÄŸiÅŸtiyse)
            echo "ðŸ“¦ Updating Python packages..."
            pip install -q --upgrade pip
            pip install -q -r requirements.txt
            
            # Dosya izinlerini dÃ¼zelt
            echo "ðŸ”§ Setting permissions..."
            sudo chown -R www-data:www-data /var/www/event-finder
            sudo chmod -R 755 /var/www/event-finder
            
            # RAG embeddings'i yeniden oluÅŸtur (opsiyonel, ilk sorguda otomatik oluÅŸacak)
            echo "ðŸ§  RAG embeddings will be regenerated on next query or service restart"
            
            # Servisi yeniden baÅŸlat
            echo "ðŸ”„ Restarting service..."
            sudo systemctl restart events
            
            # Servis durumunu kontrol et
            echo "âœ… Checking service status..."
            sleep 3
            sudo systemctl status events --no-pager || true
            
            # Health check
            echo "ðŸ¥ Health check..."
            curl -f http://localhost:5001/health || echo "âš ï¸ Health check failed (service might still be starting)"
            
            echo "âœ… Deployment completed!"
          EOF
      
      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://events.tugrul.app/health || echo "âš ï¸ Health check failed"
      
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code deployed to server" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Service restarted" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Web: https://events.tugrul.app" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š API: https://events.tugrul.app/api" >> $GITHUB_STEP_SUMMARY

